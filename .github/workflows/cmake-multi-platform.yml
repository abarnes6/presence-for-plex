name: CMake Multi-Platform Build and Package

on:
  push:
    branches: ["main", "refactor"]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  QT_VERSION: 6.6.3

jobs:
  build:
    name: ${{ matrix.os }}-${{ matrix.label }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            cpp_compiler: g++
            label: gcc
            package_artifact: 'packages-linux-gcc'
            cpack_generator: 'DEB;RPM;TGZ'
            qt_arch: 'gcc_64'

          - os: ubuntu-latest
            cpp_compiler: clang++
            label: clang
            package_artifact: 'packages-linux-clang'
            cpack_generator: 'DEB;RPM;TGZ'
            qt_arch: 'gcc_64'

          - os: windows-latest
            cpp_compiler: cl
            label: msvc
            package_artifact: 'packages-windows'
            cpack_generator: 'NSIS;ZIP'
            qt_arch: 'win64_msvc2019_64'

          - os: macos-latest
            cpp_compiler: clang++
            label: clang
            package_artifact: 'packages-macos'
            cpack_generator: 'DragNDrop;ZIP'
            qt_arch: 'clang_64'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up build directory
        id: strings
        shell: bash
        run: |
          echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

      # ======================================================================
      # Install Qt6
      # ======================================================================
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ matrix.qt_arch }}
          cache: true

      # ======================================================================
      # Install Build Tools - Ubuntu
      # ======================================================================
      - name: Install build tools (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            libxcb-cursor0 \
            rpm \
            dpkg-dev

      # ======================================================================
      # Install Build Tools - macOS
      # ======================================================================
      - name: Install build tools (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install \
            cmake \
            ninja \
            pkg-config

      # ======================================================================
      # Install Build Tools - Windows
      # ======================================================================
      - name: Install build tools (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake ninja nsis -y

      # ======================================================================
      # Configure CMake
      # ======================================================================
      - name: Configure CMake
        shell: bash
        run: |
          cmake_args=(
            -B "${{ steps.strings.outputs.build-output-dir }}"
            -S "${{ github.workspace }}"
            -G Ninja
            -DCMAKE_CXX_COMPILER="${{ matrix.cpp_compiler }}"
            -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}"
            -DBUILD_TESTING=OFF
          )

          cmake "${cmake_args[@]}"

      # ======================================================================
      # Build
      # ======================================================================
      - name: Build
        shell: bash
        run: |
          cmake --build "${{ steps.strings.outputs.build-output-dir }}" --config ${{ env.BUILD_TYPE }} --parallel

      # ======================================================================
      # Package
      # ======================================================================
      - name: Create packages
        shell: bash
        run: |
          cd "${{ steps.strings.outputs.build-output-dir }}"

          # Run CPack to create platform-specific packages
          cpack -C ${{ env.BUILD_TYPE }} -G "${{ matrix.cpack_generator }}" --verbose

          # List generated packages
          echo "Generated packages:"
          ls -lh *.exe *.dmg *.deb *.rpm *.tar.gz *.zip 2>/dev/null || true

      # ======================================================================
      # Upload Artifacts
      # ======================================================================
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package_artifact }}
          path: |
            ${{ steps.strings.outputs.build-output-dir }}/*.exe
            ${{ steps.strings.outputs.build-output-dir }}/*.dmg
            ${{ steps.strings.outputs.build-output-dir }}/*.deb
            ${{ steps.strings.outputs.build-output-dir }}/*.rpm
            ${{ steps.strings.outputs.build-output-dir }}/*.tar.gz
            ${{ steps.strings.outputs.build-output-dir }}/*.zip
          retention-days: 90
          if-no-files-found: warn

  # ==========================================================================
  # Release Job - Create GitHub Release on Tag Push
  # ==========================================================================
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files

          # Copy all package files to release directory
          find artifacts -type f \( \
            -name "*.exe" -o \
            -name "*.dmg" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.tar.gz" -o \
            -name "*.zip" \
          \) -exec cp {} release-files/ \;

          # List release files
          echo "Release files:"
          ls -lh release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation

            ### Windows
            Download `PresenceForPlex-*-win64.exe` (installer) or `PresenceForPlex-*-win64.zip` (portable)

            ### macOS
            Download `PresenceForPlex-*-Darwin.dmg` (drag-and-drop installer) or `*-Darwin.zip` (portable)

            ### Linux
            - **Debian/Ubuntu**: Download `.deb` package and install with `sudo dpkg -i PresenceForPlex-*.deb`
            - **Fedora/RHEL/openSUSE**: Download `.rpm` package and install with `sudo rpm -i PresenceForPlex-*.rpm`
            - **Other distros**: Download `.tar.gz` archive and extract

            ## Changelog
            See below for automatically generated release notes.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Summary Job - Build Summary
  # ==========================================================================
  summary:
    name: Build Summary
    needs: build
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate build summary
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Generated Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for dir in artifacts/*/; do
            platform=$(basename "$dir")
            echo "### $platform" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lh "$dir" 2>/dev/null || echo "No packages found"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done
